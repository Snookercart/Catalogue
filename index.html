<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Catalogue Flipbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #111;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    #flipbook {
      position: relative;
      width: 100%;
      height: 100%;
      perspective: 2000px;
      overflow: hidden;
    }
    .page {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      transform-origin: left center;
      transition: transform 0.6s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    .zoom-layer {
      will-change: transform;
      overflow: hidden;
      position: relative;
      width: 100%;
      height: 100%;
    }
    .page img {
      width: 100%;
      height: auto;
      user-select: none;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .page-loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
    }
    .controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      gap: 10px;
    }
    .controls button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      cursor: pointer;
    }
    #pageIndicator {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 6px 12px;
      border-radius: 6px;
      z-index: 10000;
      font-size: 14px;
    }
    #globalLoader {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      z-index: 999999;
    }
  </style>
</head>
<body>
  <div id="flipbook"></div>
  <div id="pageIndicator">Page 1/48</div>
  <div class="controls">
    <button id="prevBtn">Prev</button>
    <button id="nextBtn">Next</button>
    <button id="fullscreenBtn">Fullscreen</button>
  </div>
  <div id="globalLoader">Loading pages…</div>
  <script>
    const totalPages = 48;
    let current = 0;
    const book = document.getElementById('flipbook');
    const pageIndicator = document.getElementById('pageIndicator');

    const BATCH_SIZE = 7;
    const HALF = Math.floor(BATCH_SIZE / 2);
    let pages = [];

    function preloadImage(index) {
      return new Promise(resolve => {
        if (index < 0 || index >= totalPages) return resolve(null);
        const img = new Image();
        img.src = `page_${String(index+1).padStart(3,'0')}.png`;
        img.decode().then(()=>resolve({img,index})).catch(()=>resolve(null));
      });
    }

    function createPage(i) {
      const page = document.createElement('div');
      page.className = 'page';
      page.dataset.index = i;
      const zoomLayer = document.createElement('div');
      zoomLayer.className = 'zoom-layer';
      const img = document.createElement('img');
      img.draggable = false;
      const loader = document.createElement('div');
      loader.className = 'page-loader';
      loader.textContent = 'Loading…';
      zoomLayer.appendChild(img);
      page.appendChild(zoomLayer);
      page.appendChild(loader);
      return {page, img, zoomLayer, loader};
    }

    function loadBatch(centerIndex) {
      document.getElementById('globalLoader').style.display = 'flex';
      const start = Math.max(0, centerIndex - HALF);
      const end = Math.min(totalPages - 1, centerIndex + HALF);
      book.innerHTML = '';
      pages = [];
      const promises = [];
      for (let i = start; i <= end; i++) {
        const {page, img, zoomLayer, loader} = createPage(i);
        book.appendChild(page);
        pages.push({page, img, zoomLayer, loader});
        promises.push(preloadImage(i).then(res => {
          if (res) {
            img.src = res.img.src;
            img.style.opacity = '1';
            loader.style.display = 'none';
          }
        }));
      }
      Promise.all(promises).then(() => {
        document.getElementById('globalLoader').style.display = 'none';
        showPage(centerIndex);
      });
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function showPage(n) {
      if (!pages.find(p => +p.page.dataset.index === n)) {
        loadBatch(n);
        return;
      }
      current = clamp(n, 0, totalPages-1);
      pages.forEach(p => {
        const pageIndex = +p.page.dataset.index;
        p.page.style.zIndex = (pageIndex === current ? 100 : 0);
      });
      pageIndicator.textContent = `Page ${current+1}/${totalPages}`;
    }

    document.getElementById('prevBtn').onclick = ()=>showPage(current-1);
    document.getElementById('nextBtn').onclick = ()=>showPage(current+1);
    document.getElementById('fullscreenBtn').onclick = ()=>{
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    };

    document.addEventListener('keydown', e=>{
      if (e.key==='ArrowRight' || e.key==='PageDown') showPage(current+1);
      if (e.key==='ArrowLeft' || e.key==='PageUp') showPage(current-1);
    });

    loadBatch(0);
  </script>
</body>
</html>
