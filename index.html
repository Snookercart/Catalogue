<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Catalogue Flipbook (Animated)</title>
  <style>
    html,body{height:100%;margin:0;padding:0;background:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
    #flipbook{position:relative;width:100vw;height:100vh;perspective:2000px;background:#fff;overflow:hidden}

    .page{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      background:#fff;
      backface-visibility:hidden;
      transform-origin:left center;
    }

    /* Zoom wrapper */
    .zoom-layer{will-change:transform;transform-origin:center center;display:flex;align-items:center;justify-content:center;touch-action:none}
    .zoom-layer img{max-width:100%;max-height:100%;object-fit:contain;user-select:none;pointer-events:none;display:block;opacity:0;transition:opacity .25s}

    .page-loader{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.55);color:#fff;padding:6px 10px;border-radius:6px;font-size:13px}

    /* Controls */
    .controls{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:2147483647;display:flex;gap:8px}
    .controls button{padding:8px 12px;border-radius:6px;border:1px solid rgba(0,0,0,.08);background:#fff;color:#111;cursor:pointer}

    #pageIndicator{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:#fff;padding:6px 10px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.08);z-index:2147483647}

    #globalLoader{position:fixed;inset:0;background:rgba(255,255,255,0.85);display:none;align-items:center;justify-content:center;color:#111;font-size:18px;z-index:999999}

    /* Flip Animations */
    @keyframes flipForward {
      0%   { transform: rotateY(0deg) scale(1) translateX(0); }
      50%  { transform: rotateY(-90deg) scale(0.98) translateX(-10%); }
      100% { transform: rotateY(-180deg) scale(1) translateX(0); }
    }
    @keyframes flipBackward {
      0%   { transform: rotateY(-180deg) scale(1) translateX(0); }
      50%  { transform: rotateY(-90deg) scale(0.98) translateX(10%); }
      100% { transform: rotateY(0deg) scale(1) translateX(0); }
    }

    .animate-forward { animation: flipForward 0.9s ease-in-out forwards; transform-origin:left center; }
    .animate-backward { animation: flipBackward 0.9s ease-in-out forwards; transform-origin:right center; }

    #flipbook, .page, .zoom-layer{pointer-events:auto}
  </style>
</head>
<body>
  <div id="flipbook" aria-live="polite"></div>
  <div id="pageIndicator">Page 1/48</div>
  <div class="controls">
    <button id="prevBtn">Prev</button>
    <button id="nextBtn">Next</button>
    <button id="fullscreenBtn">Fullscreen</button>
  </div>
  <div id="globalLoader">Loading pages…</div>

  <script>
    const totalPages = 48;
    const BATCH_SIZE = 7;
    const HALF = Math.floor(BATCH_SIZE/2);

    let current = 0;
    const flipbook = document.getElementById('flipbook');
    const pageIndicator = document.getElementById('pageIndicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const globalLoader = document.getElementById('globalLoader');

    let pages = [];
    const imageCache = new Map();

    let scale = 1, offsetX = 0, offsetY = 0;
    let animFrame = null;
    let isMousePanning = false; let panStart = {x:0,y:0};
    let lastTouchDistance = 0; let pinchStartScale = 1;
    let lastTap = 0;

    function srcFor(i){ return `page_${String(i+1).padStart(3,'0')}.png`; }

    function preloadImage(index){
      if (index < 0 || index >= totalPages) return Promise.resolve(null);
      if (imageCache.has(index)) return Promise.resolve(imageCache.get(index));
      return new Promise(resolve=>{
        const img = new Image();
        img.decoding = 'async';
        img.onload = ()=>{ const entry = {img, width: img.naturalWidth, height: img.naturalHeight}; imageCache.set(index, entry); resolve(entry); };
        img.onerror = ()=>resolve(null);
        img.src = srcFor(index);
      });
    }

    function createPage(index){
      const page = document.createElement('div');
      page.className = 'page';
      page.dataset.index = index;

      const zoomLayer = document.createElement('div');
      zoomLayer.className = 'zoom-layer';

      const img = document.createElement('img');
      img.alt = `Page ${index+1}`;
      img.draggable = false;

      const loader = document.createElement('div');
      loader.className = 'page-loader';
      loader.textContent = 'Loading…';

      zoomLayer.appendChild(img);
      page.appendChild(zoomLayer);
      page.appendChild(loader);
      return {page, img, zoomLayer, loader, index};
    }

    async function loadBatch(centerIndex){
      globalLoader.style.display = 'flex';
      const start = Math.max(0, centerIndex - HALF);
      const end = Math.min(totalPages - 1, centerIndex + HALF);

      flipbook.innerHTML = '';
      pages = [];

      for (let i = start; i <= end; i++){
        const shell = createPage(i);
        flipbook.appendChild(shell.page);
        pages.push(shell);
      }

      const tasks = pages.map(p => preloadImage(p.index).then(entry=>{
        if (!entry) return;
        p.img.src = entry.img.src;
        p.img.style.opacity = '1';
        p.loader.style.display = 'none';
      }));

      await Promise.all(tasks);
      resetPanZoom();
      globalLoader.style.display = 'none';
      showPage(centerIndex, true);

      if (end + 1 < totalPages) preloadImage(end+1);
      if (start - 1 >= 0) preloadImage(start-1);

      for (const k of Array.from(imageCache.keys())){
        if (Math.abs(k - centerIndex) > 12) imageCache.delete(k);
      }
    }

    function scheduleTransform(){
      if (animFrame) return;
      animFrame = requestAnimationFrame(()=>{
        animFrame = null;
        const cur = getCurrentShell();
        if (!cur) return;
        cur.zoomLayer.style.transform = `translate3d(${offsetX}px, ${offsetY}px, 0) scale(${scale})`;
      });
    }

    function resetPanZoom(){ scale = 1; offsetX = 0; offsetY = 0; scheduleTransform(); }
    function getCurrentShell(){ return pages.find(p => +p.page.dataset.index === current); }

    function showPage(n, instant=false){
      if (n < 0 || n >= totalPages) return;
      if (!pages.find(p => p.index === n)){ loadBatch(n); return; }

      const prev = current;
      current = n;

      pages.forEach(p=>{ p.page.style.zIndex = (p.index === current ? 100 : 0); });

      // apply animation
      if (!instant){
        const curPage = getCurrentShell();
        if (n > prev) curPage.page.classList.add('animate-forward');
        else curPage.page.classList.add('animate-backward');

        setTimeout(()=>{ curPage.page.classList.remove('animate-forward','animate-backward'); }, 950);
      }

      pageIndicator.textContent = `Page ${current+1}/${totalPages}`;
      resetPanZoom();
      preloadImage(current+1); preloadImage(current-1);
    }

    prevBtn.addEventListener('click', ()=> showPage(current-1));
    nextBtn.addEventListener('click', ()=> showPage(current+1));

    fullscreenBtn.addEventListener('click', async ()=>{
      try{
        if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      } catch(e){ console.warn('fullscreen error', e); }
    });

    document.addEventListener('fullscreenchange', ()=>{
      const host = document.fullscreenElement || document.body;
      const controls = document.querySelector('.controls');
      if (controls && controls.parentNode !== host) host.appendChild(controls);
      if (globalLoader.parentNode !== document.body) document.body.appendChild(globalLoader);
    });

    preloadImage(0).then(()=> loadBatch(0));
  </script>
</body>
</html>
