<script>
  const totalPages = 10;
  const book = document.getElementById("book");
  const pageIndicator = document.getElementById("pageIndicator");
  const pages = [];
  let current = 0;
  let scale = 1;
  let offsetX = 0, offsetY = 0;
  let isDragging = false;
  let startX, startY;
  let doubleZoomed = false;
  let currentImg = null;
  let lastTap = 0;

  // Create pages
  function createPages() {
    for (let i = 1; i <= totalPages; i++) {
      const page = document.createElement("div");
      page.className = "page";
      page.style.zIndex = totalPages - i + 1;

      const inner = document.createElement("div");
      inner.className = "page-inner";

      const img = document.createElement("img");
      img.src = `page_${String(i).padStart(3, "0")}.png`;
      img.alt = `Page ${i}`;

      inner.appendChild(img);
      page.appendChild(inner);
      book.appendChild(page);
      pages.push(page);
    }
  }

  // Show page
  function showPage(n) {
    current = Math.max(0, Math.min(n, totalPages - 1));
    pages.forEach((page, idx) => {
      page.classList.toggle("flipped", idx < current);
    });
    pageIndicator.textContent = `Page ${current + 1}/${totalPages}`;
    currentImg = pages[current].querySelector("img");
    resetPanZoom();
    applyZoom();
  }

  function resetPanZoom() {
    offsetX = 0;
    offsetY = 0;
    scale = 1;
    doubleZoomed = false;
    applyZoom();
  }

  function applyZoom() {
    if (!currentImg) return;
    currentImg.style.transform = `scale(${scale}) translate(${offsetX / scale}px, ${offsetY / scale}px)`;
  }

  // Arrows only control flipping
  document.querySelector(".arrow.right").addEventListener("click", (e) => {
    e.stopPropagation();
    if (current < totalPages - 1) showPage(current + 1);
  });

  document.querySelector(".arrow.left").addEventListener("click", (e) => {
    e.stopPropagation();
    if (current > 0) showPage(current - 1);
  });

  // Double tap for zoom
  document.addEventListener("touchstart", (e) => {
    const now = new Date().getTime();
    const timeSince = now - lastTap;
    lastTap = now;

    // Ignore if arrow clicked
    if (e.target.closest('.arrow')) return;

    // Double tap logic
    if (timeSince < 300 && e.touches.length === 1) {
      if (!doubleZoomed) {
        scale = 2;
      } else {
        scale = 1;
        offsetX = 0;
        offsetY = 0;
      }
      doubleZoomed = !doubleZoomed;
      applyZoom();
      e.preventDefault();
    }

    // Setup for drag/swipe
    const touch = e.touches[0];
    startX = touch.clientX;
    startY = touch.clientY;
    isDragging = false;
  }, { passive: false });

  // Handle pan/drag/swipe
  document.addEventListener("touchmove", (e) => {
    if (!currentImg || e.touches.length !== 1) return;

    const touch = e.touches[0];
    const dx = touch.clientX - startX;
    const dy = touch.clientY - startY;

    // Pan (when zoomed in)
    if (scale > 1) {
      offsetX += dx;
      offsetY += dy;
      applyZoom();
      isDragging = true;
      startX = touch.clientX;
      startY = touch.clientY;
      e.preventDefault();
    }
  }, { passive: false });

  document.addEventListener("touchend", (e) => {
    // Swipe only when NOT zoomed in
    if (!isDragging && scale === 1 && e.changedTouches.length === 1) {
      const touch = e.changedTouches[0];
      const dx = touch.clientX - startX;
      const dy = touch.clientY - startY;

      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
        if (dx < 0 && current < totalPages - 1) {
          showPage(current + 1);
        } else if (dx > 0 && current > 0) {
          showPage(current - 1);
        }
      }
    }

    isDragging = false;
  });

  // Mouse drag for desktop (optional)
  document.addEventListener("mousedown", (e) => {
    if (scale <= 1 || !currentImg) return;
    if (e.target.closest(".arrow")) return;
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    e.preventDefault();
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging || scale <= 1 || !currentImg) return;
    offsetX += e.clientX - startX;
    offsetY += e.clientY - startY;
    startX = e.clientX;
    startY = e.clientY;
    applyZoom();
    e.preventDefault();
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
  });

  // Fullscreen toggle (optional)
  const fullscreenBtn = document.createElement("button");
  fullscreenBtn.textContent = "Fullscreen";
  fullscreenBtn.style.cssText = `
    position: fixed;
    bottom: 15px;
    right: 15px;
    padding: 6px 12px;
    border: none;
    background: rgba(0,0,0,0.7);
    color: white;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 300;
  `;
  fullscreenBtn.addEventListener("click", () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });
  document.body.appendChild(fullscreenBtn);

  // Init
  createPages();
  showPage(0);
</script>
